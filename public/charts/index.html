<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
	<style>
		body,
		html {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			background-color: #010501;
			overflow: hidden;
		}

		#tv_chart_container {
			height: 100vh;
			width: 100vw;
		}

		#error-display {
			position: absolute;
			top: 10px;
			left: 10px;
			color: red;
			font-family: monospace;
			font-size: 10px;
			z-index: 9999;
		}
	</style>
</head>

<body>
	<div id="error-display"></div>
	<div id="tv_chart_container"></div>

	<script type="text/javascript">
		function log(m) {
			console.log(m);
			if (window.ReactNativeWebView) window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'LOG', message: m }));
		}
		function err(m) {
			document.getElementById('error-display').innerText = m;
			log("‚ùå ERROR: " + m);
		}

		window.onerror = function (m, s, l) { err(m + " at line " + l); };
		log("1. WebView starting...");
	</script>

	<!-- Load scripts with error tracking -->
	<script type="text/javascript" src="charting_library/charting_library.standalone.js"
		onerror="err('Library load failed')"></script>
	<script type="text/javascript" src="datafeed.js" onerror="err('Datafeed script failed')"></script>

	<script type="text/javascript">
		log("2. Scripts loaded. Checking TradingView object...");

		function getParam(n) {
			const v = new RegExp('[?&]' + n + '=([^&#]*)').exec(window.location.href);
			return v ? decodeURIComponent(v[1]) : null;
		}

		function init() {
			if (typeof TradingView === 'undefined') {
				return err("TradingView library not found in global scope");
			}

			log("3. Initializing widget for " + getParam('symbol'));

			const widget = window.tvWidget = new TradingView.widget({
				symbol: getParam('symbol') || 'BTC-USD',
				interval: getParam('interval') || '60',
				container: "tv_chart_container",
				datafeed: window.tiwiDatafeed,
				library_path: "charting_library/",
				locale: "en",
				theme: "dark",
				autosize: true,
				timezone: "Etc/UTC",
				toolbar_bg: "#010501",
				overrides: {
					"paneProperties.background": "#010501",
					"paneProperties.vertGridProperties.color": "transparent",
					"paneProperties.horzGridProperties.color": "transparent",
					"mainSeriesProperties.candleStyle.upColor": "#3FEA9B",
					"mainSeriesProperties.candleStyle.downColor": "#FF5C5C",
				},
				disabled_features: ["header_symbol_search", "header_compare"],
				enabled_features: ["study_templates"]
			});

			widget.onChartReady(function () {
				log("4. Widget Ready event fired");
				if (window.ReactNativeWebView) {
					window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'ON_CHART_READY' }));
				}
			});
		}

		window.addEventListener('DOMContentLoaded', function () {
			log("DOM Content Ready");
			setTimeout(init, 500); // Small delay to ensure scripts are parsed
		});
	</script>
</body>

</html>