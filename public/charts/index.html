<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
	<style>
		body,
		html {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			background-color: #010501;
			overflow: hidden;
		}

		#tv_chart_container {
			height: 100vh;
			width: 100vw;
		}
	</style>
</head>

<body>
	<div id="tv_chart_container"></div>

	<!-- Script resolution relative to the public/chart/ folder -->
	<script type="text/javascript" src="charting_library/charting_library.standalone.js"></script>
	<script type="text/javascript" src="datafeed.js"></script>

	<script type="text/javascript">
		// Internal Bridge Logger for React Native Debugging
		function logToNative(msg) {
			if (window.ReactNativeWebView) {
				window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'LOG', message: msg }));
			}
		}

		window.onerror = function (message, source, lineno, colno, error) {
			logToNative("JS ERROR: " + message + " at " + lineno + ":" + colno);
			return true;
		};

		function getParameterByName(name) {
			var url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}

		function initChart() {
			var symbol = getParameterByName('symbol') || 'BTC-USD';
			var interval = getParameterByName('interval') || '60';

			const widgetOptions = {
				symbol: symbol,
				interval: interval,
				container: "tv_chart_container",
				datafeed: window.tiwiDatafeed,
				library_path: "charting_library/",
				locale: "en",
				theme: "dark",
				autosize: true,
				fullscreen: false,
				timezone: "Etc/UTC",
				toolbar_bg: "#010501",
				overrides: {
					"paneProperties.background": "#010501",
					"paneProperties.backgroundType": "solid",
					"paneProperties.vertGridProperties.color": "transparent",
					"paneProperties.horzGridProperties.color": "transparent",
					"mainSeriesProperties.candleStyle.upColor": "#3FEA9B",
					"mainSeriesProperties.candleStyle.downColor": "#FF5C5C",
				},
				disabled_features: [
					"header_symbol_search",
					"header_compare",
					"use_localstorage_for_settings",
					"display_market_status"
				],
				enabled_features: ["study_templates"]
			};

			const widget = window.tvWidget = new TradingView.widget(widgetOptions);

			widget.onChartReady(() => {
				if (window.ReactNativeWebView) {
					window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'ON_CHART_READY' }));
				}
			});
		}

		// Wait for datafeed to be ready
		window.addEventListener('DOMContentLoaded', initChart);
	</script>
</body>

</html>